<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Frog Fighter</title>
  <style>
    body {
      margin: 0;
      background: #a3d977;
      font-family: sans-serif;
    }
    canvas {
      display: block;
      margin: 10px auto;
      background: #d0f0c0;
    }
    input, button {
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div style="text-align: center; margin-top: 10px;">
    <input id="ipInput" placeholder="ws://localhost:8080" value="ws://localhost:8080" style="padding: 6px; width: 300px;" />
    <button id="connectBtn" style="padding: 6px 12px;">Connect</button>
  </div>
  <canvas id="game" width="800" height="600"></canvas>

<script>
let socket;
let players = {};
let myId = null;
let posX = 100 + Math.random() * 400;
let posY = 100 + Math.random() * 400;
const keys = {};
const speed = 2.5;
let gameLoopRunning = false;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Tongue attack
let tongueTarget = null;
let tongueProgress = 0;
const tongueSpeed = 0.25;

// Key handling
document.addEventListener("keydown", e => {
  keys[e.key.toLowerCase()] = true;
});
document.addEventListener("keyup", e => {
  keys[e.key.toLowerCase()] = false;
});

// Handle tongue attack on click
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  tongueTarget = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
  tongueProgress = 0;

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: 'attack', x: tongueTarget.x, y: tongueTarget.y }));
  }
});

// Connect button
document.getElementById("connectBtn").addEventListener("click", connect);
document.getElementById("ipInput").addEventListener("keydown", e => {
  if (e.key === "Enter") connect();
});

function connect() {
  const ip = document.getElementById("ipInput").value;
  socket = new WebSocket(ip);

  socket.onopen = () => {
    console.log("Connected to", ip);
    if (!gameLoopRunning) {
      gameLoopRunning = true;
      requestAnimationFrame(gameLoop);
    }
  };

  socket.onclose = () => {
    alert("Disconnected from server");
    gameLoopRunning = false;
  };

  socket.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'state') {
      players = {};
      data.players.forEach(p => players[p.id] = p);

      if (!myId) {
        myId = data.players.find(p => Math.abs(p.x - posX) < 5 && Math.abs(p.y - posY) < 5)?.id;
      }
    }
  };
}

function drawPlayer(p) {
  ctx.fillStyle = p.color;
  ctx.beginPath();
  ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
  ctx.fill();

  // Eyes
  const eyeOffsetX = 8;
  const eyeOffsetY = -12;
  for (let side of [-1, 1]) {
    ctx.beginPath();
    ctx.fillStyle = "white";
    ctx.arc(p.x + side * eyeOffsetX, p.y + eyeOffsetY, 5, 0, Math.PI * 2);
    ctx.fill();

    ctx.beginPath();
    ctx.fillStyle = "black";
    ctx.arc(p.x + side * eyeOffsetX, p.y + eyeOffsetY, 2, 0, Math.PI * 2);
    ctx.fill();
  }

  // Health bar
  ctx.fillStyle = "red";
  ctx.fillRect(p.x - 20, p.y - 30, Math.max(0, p.hp) / 2, 5);
}

function gameLoop() {
  // Update position
  if (keys['w'] || keys['arrowup']) posY -= speed;
  if (keys['s'] || keys['arrowdown']) posY += speed;
  if (keys['a'] || keys['arrowleft']) posX -= speed;
  if (keys['d'] || keys['arrowright']) posX += speed;

  // Stay within bounds
  posX = Math.max(20, Math.min(canvas.width - 20, posX));
  posY = Math.max(20, Math.min(canvas.height - 20, posY));

  // Send updated position to server
  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: 'move', x: posX, y: posY }));
  }

  // Clear and redraw
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (const id in players) {
    if (players[id].hp > 0) {
      drawPlayer(players[id]);
    }
  }

  // Animate tongue
  if (tongueTarget && tongueProgress < 1) {
    tongueProgress += tongueSpeed;
    const tx = posX + (tongueTarget.x - posX) * tongueProgress;
    const ty = posY + (tongueTarget.y - posY) * tongueProgress;

    ctx.strokeStyle = "pink";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(posX, posY);
    ctx.lineTo(tx, ty);
    ctx.stroke();

    if (tongueProgress >= 1) {
      tongueTarget = null;
    }
  }

  requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
